services:
  # Configuration setup service - runs once to create .env if missing
  diasync-setup:
    image: alpine:latest
    volumes:
      - .:/workspace
    working_dir: /workspace
    command: |
      sh -c '
        if [ ! -f .env ]; then
          echo "🔧 Creating default .env file..."
          cat > .env << EOF
      # DiaSync Configuration - Auto-generated
      # Edit these values with your actual credentials

      # Device Selection - Choose ONE option
      DEVICE_TYPE=Dexcom

      # Dexcom Configuration (only if using Dexcom)
      DEXCOM_USERNAME=your_dexcom_username
      DEXCOM_PASSWORD=your_dexcom_password
      DEXCOM_REGION=us

      # Abbott Configuration (only if using Abbott/FreestyleLibre/Freestyle)
      ABBOTT_USERNAME=your_abbott_username
      ABBOTT_PASSWORD=your_abbott_password
      ABBOTT_REGION=eu

      # Nightscout Configuration (required)
      NIGHTSCOUT_URL=https://your-nightscout.us.nightscoutpro.com
      NIGHTSCOUT_API_SECRET=your_api_secret
      EOF
          echo "✅ Default .env created! Please edit it with your credentials."
          echo "📝 Then run: docker-compose up diasync"
        else
          echo "✅ .env file already exists"
        fi
      '
    profiles:
      - setup

  diasync:
    image: zbaize01/diasync:production
    container_name: diasync
    restart: unless-stopped
    env_file:
      - .env
    depends_on:
      - diasync-setup
